# Уровни переопределения

* [Определение](#)
* [Принцип работы](#)
* [Примеры использования](#)

## Определение

Уровень переопределения — это директория в БЭМ-проекте, которая содержит файлы реализаций [блоков](../key-concepts/key-concepts.ru.md#Блок), [элементов](../key-concepts/key-concepts.ru.md#Элемент) и [модификаторов](../key-concepts/key-concepts.ru.md#Модификатор). БЭМ-проект всегда состоит из уровней переопределения (далее также «уровней»). 

Пример файловой структуры БЭМ-проекта:

```files
project/
    level-1/                # уровень переопределения
        block-1/
        block-2/
        block-n/
```

С помощью уровней в БЭМ-проекте можно:
* [изменять существующие блоки](#Изменение-существующей-реализации-блока)
* [добавлять новые блоки в проект](#Добавление-блоков-в-проект)

Уровни переопределния обеспечивают 

* [Работу с одиними и теми же БЭМ-сущностями](#Изменение-существующей-реализации-блока)  
  Нет необходимости создавать новую сущность, если нужно изменить уже существующую. Блок может быть переопределен или доопределен без изменения его исходной реализации и имени.   
* [Сохранение проектных изменений у блоков при обновлении библиотеки](#Подключение-библиотеки-блоков-в-проект)  
  Библиотека подключается в проект на отдельный уровень, а изменения описываются на другом уровне переопределения.  
* [Отказ от дублирования кода](#Разделение-проекта-на-платформы)  
  Код проекта разделяется на общую и специфическую части. Такой подход позволяет подключать общий код в проект. При появлении ошибки в общем коде необходимо исправлять ее один раз, изменения применятся во все проекты.  
* [Проведение экспериментов в рабочем проекте](#Эксперименты-в-рабочем-проекте)  
  Эксперимент проводится на отдельном уровне переопределения, код рабочего проекта остается неизменным.

## Принцип работы

Работа с уровнями переопределения основана на следующих принципах:

* [БЭМ-проект состоит минимум из одного уровня переопределения](#БЭМ-проект-состоит-минимум-из-одного-уровня-переопределения)
* [Реализация блока собирается с разных уровней переопределения](#Реализация-блока-собирается-с-разных-уровней-переопределения)
* [Количество и порядок подключения уровней настраивается для каждого случая отдельно](#Количество-и-порядок-подключения-уровней-настраивается-для-каждого-случая-отдельно)

### БЭМ-проект состоит минимум из одного уровня переопределения

В БЭМ-методологии реализация блока состоит из отдельных файлов технологий (`button.css`, `button.js`) — исходных файлов. Все исходные файлы блоков проекта хранятся в группирующих директориях, если говорить в терминах БЭМ — на уровнях переопределения. Минимальное количество уровней переопределения в проекте — один. Максимальное – не ограничено. 

Пример файловой структуры БЭМ-проекта с одним уровнем переопределения:

```files
project/
    blocks/                # уровень переопределения с блоками проекта
        header/
            header.css    
            header.js
        footer/
            footer.css    
            footer.js
```

Пример файловой структуры БЭМ-проекта с тремя уровнями переопределения (общие блоки проекта и блоки для отдельных страниц):

```files
project/
    common.blocks/                # уровень переопределения с блоками проекта
        header/
            header.css    
            header.js
        footer/
            footer.css    
            footer.js
    index/                        # уровень переопределения с блоками для страницы index
        blocks/
            head/
                head.css          # переопределили вид шапки на заглавной странице
    about/                        # уровень переопределения с блоками для страницы about
        blocks/
            about-text/           # добавили новый блок
                about-text.css                
```

### Реализация блока собирается с разных уровней переопределения

Блоки с любого уровня могут быть изменены на другом уровне переопределения. Изменяемую реализацию блока будем в дальнейшем называть исходной, а измененную — финальной.

Исходная реализация блока дополняется или перекрывается реализациями с каждого последующего уровня. Количество уровней, с которых собирается финальная реализация блока, и порядок их подключения может быть любым. Поэтому при сборке финального результата важно определить последовательность подключения уровней в проект. В сборку сначала должна попасть исходная реализация, а затем — изменения со всех уровней переопределения.

> Подробнее о [сборке БЭМ-проектов и порядке подключения БЭМ-сущностей в проект](https://ru.bem.info/methodology/build).

![схема работы уровней переопределения](https://github.com/innabelaya/bem-docs/blob/master/pics/redefinition-level/levels.png)

В качестве примера рассмотрим подключение сторонней библиотеки в БЭМ-проект.

#### Подключение библиотеки блоков в проект

Библиотека подключается в БЭМ-проект как отдельный уровень. Блоки из библиотеки могут использоваться в проекте [без изменений](#Добавление-блоков-в-проект) или [дорабатываться под требования проекта](#Изменение-существующей-реализации-блока). 

##### Добавление блоков в проект

Готовая реализация блока может подключаться в проект без изменения с любого уровня, в том числе и с уровня подключенной библиотеки. 

Предположим, в проекте необходимо использовать кнопку из сторонней библиотеки. Для этого достаточно подключить в проект библиотеку с блоком `button` на отдельный уровень. Копировать код блока `button` на уровень с общими проектными блоками не нужно.

Файловая система проекта с подключенным уровнем библиотеки:

```files
project/
    common.blocks/                      # уровень переопределения с блоками проекта
        header/
        logo/
    library.blocks/                     # уровень переопределения c блоками библиотеки
        button/                         # блок button 
```

В результате [сборки проекта](../build/build.ru.md) блок `button` будет подключен в проект. 

```css
@import "common.blocks/header/header.css";     /* CSS-правила блока header с уровня общих блоков проекта */
@import "library.blocks/logo/logo.css";        /* CSS-правила блока logo с уровня общих блоков проекта */
@import "common.blocks/button/button.css";     /* CSS-правила блока button с уровня библиотеки */
```

##### Изменение существующей реализации блока

Блоки с любого уроня переопределения можно изменять под требования проекта на другом уровне: 

* добавлять новые свойства (**доопределять**);
* изменять существующие свойства (**переопределять**). 

> Разделение реализации блока по уровням переопределения позволяет сохранить проектные изменения в блоках при обновлении библиотеки. 

Рассмотрим на примере блока `button` из библиотеки, которая подключена в проект как отдельный уровень (`library.blocks`): 

```files
project/
    common.blocks/                      # уровень переопределения с блоками проекта
        header/
        logo/
    library.blocks/                     # уровень переопределения c блоками библиотеки
        button/                         # блок button 
```

Исходная CSS-реализация блока `button`:

```css
/* Блок button в технологии CSS на уровне library.blocks */

.button {
    position: absolute;
    border: 1px solid rgba(0,0,0,.2);
    border-radius: 3px;
    background-color: #fff;
```

[button-default](https://github.com/innabelaya/bem-docs/blob/master/pics/redefinition-level/button-default.png?raw=true)

Внесем изменения:

* Переопределим блок — изменим цвет и размер кнопки.
* Доопределим блок — добавим кнопке тень.

Для этого создадим блок `button` на уровне проекта `common.blocks` и разместим в нем файл `button.css` с новыми CSS-правилами для блока `button`.

Файловая структура проекта с блоком `button` на уровне `common.blocks`:

```files
project/
    common.blocks/                      # уровень переопределения с блоками проекта
        header/
        logo/
        button/
            button.css                  # новые правила для блока button
    library.blocks/                     # уровень переопределения c блоками библиотеки
        button/                         # блок button 
            button.css
            button.js
```

Новые CSS-правила:

```css
/* Блок button в технологии CSS на уровне common.blocks */

.button {
    background-color: #ffdf3a;            /* Новый цвет кнопки */
    width: 150px;                         /* Ширина кнопки */
    box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Параметры тени */
}
```

В результате сборки реализация блока `button` будет состоять из исходных CSS-правил с уровня `library.blocks` и добавленных — с уровня `common.blocks`:

```css
@import "library.blocks/button/button.css";   /* Исходные CSS-правила с уровня библиотеки */
@import "common.blocks/button/button.css";    /* Особенности с уровня common.blocks*/
```

Повторяющееся свойство (`background-color`) будет переопределено (фон кнопки из белого превратится в желтый), а новые свойства (`width` и `box-shadow`) — добавлены. Блоку `button` применится следующий набор свойств:


```css
.button {
    position: absolute;
    border: 1px solid rgba(0,0,0,.2);
    border-radius: 3px;
    background-color: #ffdf3a;            /* Новый цвет кнопки */
    width: 150px;                         /* Ширина кнопки */
    box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Параметры тени */
}
```

![Переопределенная кнопка](https://github.com/innabelaya/bem-docs/blob/master/pics/redefinition-level/button-redefined.png)

В результате изменения блока из библиотеки с помощью уровней переопределения:

* Исходная реализация блока не изменится;
* Переопределенные правила из файла `button.css` с уровня проекта применятся ко всем кнопкам.
* Обновление библиотеки не затронет изменения кнопок для проекта, так как библиотека находится на одном уровне переопределения, а специфические реализации (доработки) блоков — на другом. Если в новой версии библиотеки изменится фон кнопки или ее размеры, в проекте для блока `button` все равно применятся переопределнные правила. 

> **Важно** Можно переопределять не только CSS-свойства блока, но и его [методы](https://ru.bem.info/methodology/js/#Работа-с-уровнями-переопределения) и шаблоны.  
В БЭМ-проекте любая технология реализации блока может быть пере- или доопределена. Подробнее читайте в разделе [Платформа](https://ru.bem.info/platform/bem-xjst/runtime/).

### Количество и порядок подключения уровней настраивается для каждого случая отдельно

> Файлы, полученные в результате сборки, в БЭМ-методологии принято называть **бандлами**.

В одном проекте можно настраивать разные варианты сборки: определять последовательность и множество уровней для каждого отдельного [бандла](../build/build.ru.md/#Введение). Это позволяет иметь одновременно разные сборки одного проекта и отдавать необходимый варинт в зависимотси от юзер-агента. 

В качестве примера рассмотрим разделение проекта на платформы. 

#### Разделение проекта на платформы

В проекте, поддерживающем разные платформы (например, `mobile` и `desktop`), часть кода описывает общую функциональность и часть — специфичную для каждой платформы. Чтобы не копировать общий код для реализации каждой из платформ, используются уровни переопределения. 

Общие реализации блоков для всех платформ находятся на одном уровне, например, `common.blocks`, а специфические реализации блоков бля мобильных и настольный устройств на двух других: 

* common.blocks — общие реализации блоков для всех платформ;
* desktop.blocks — специфические реализации блоков для настольных устройств;
* mobile.blocks — специфические реализации блоков для мобильных устройств.

Файловая структура подобного проекта:

```files
project/
    common.blocks/
        button/
            button.css    # базовая CSS-реализация кнопки

    desktop.blocks/   
        button/
            button.css    # особенности кнопки для настольных устройств

    mobile.blocks/
        button/
            button.css    # особенности кнопки для мобильных устройств
```

При сборке в файл `desktop.css` попадут все базовые CSS-правила кнопки с уровня `common` и переопределенные правила с уровня `desktop`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "desktop.blocks/button/button.css";   /* Особенности desktop */
```

Файл `mobile.css` будет включать базовые CSS-правила кнопки с уровня `common` и переопределенные правила с уровня `mobile`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "mobile.blocks/button/button.css";    /* Особенности mobile */
```

На рисунке показана сборка проекта для разных платформ в зависимости от юзер-агента:

![Уровни переопределения](https://cdn.rawgit.com/bem-site/bem-method/bem-info-data/method/build/build__levels.svg)


## Примеры использования

Наиболее распространенные способы использования уровней переопределения в проекте:
* Разделение кода на общую и специфичную части  
  * [Разработка проектов, использующих общие блоки](#Разработка-проектов-использующих-общие-блоки)
  * [Создание разных тем оформления для проекта](#Создание-разных-тем-оформления-для-проекта)
  * [Разделение проекта на платформы](#Разделение-проекта-на-платформы)  
* [Эксперименты в рабочем проекте](#Эксперименты-в-рабочем-проекте)


### Разработка проектов, использующих общие блоки

Блоки, использующиеся в нескольких проектах, могут быть вынесены на отдельный уровень и подключаться при сборке:

```
common.blocks/      # общие блоки для нескольких проектов
    b1/
    b2/

project-1/          # проект 1
    b1/             # переопределние блока b1 для проекта 1
    b2/
    b3/             # уникальный блок проекта 1

project-2/          # проект 2
    b1/             # переопределние блока b1 для проекта 2
    b2/
    b4/             # уникальный блок проекта 2     
```

![](https://github.com/innabelaya/bem-docs/blob/master/pics/redefinition-level/similar-projects-1.png)

### Создание-разных-тем-оформления-для-проекта

Поведение и внешний вид проекта можно разделить на разные уровни переопределения. Это позволит создавать разные варианты оформления, переключаться между ними и комбинировать, не изменяя бизнес-логику проекта.

В примере код, отвечающий за внешний вид проекта, вынесен на отдельный уровень (`design`), а общая логика работы находится на уровне `common`:

```files
common/             # бизнес-логика проекта
    button/
    input/
    ...
alfa/               # тема оформления alfa
    button/
    input/
beta/               # тема оформления beta
    button/
    input/
```

### Эксперименты в рабочем проекте

Уровни переопределения позволяют проводить A/B тестирование непосредственно в рабочем проекте. При этом существующий код проекта остается без изменений. 

Рассмотрим пример изменения фотографий пользователя. 
Задачи разработчика: 
* изменить все фотографии всех пользователей на всех страницах сайта
* провести тестирование
* выбрать наиболее подходящий вариант
* применить новый формат в проетке 

Для решения подобных задач без уровней переопределения необходимо:
* найти все случаи использования блока `user-pic` на каждой странице (если блок встречается на странице 15 раз, а страниц в проекте 30, то случаев будет 450);
* написать для каждого случая условие проверки (`if`);  
    ```
      if (пользователь попал в эксперимент 'круг')
      {
      отобрази фотографии пользователей в круглыми;
      };
      if (пользователь попал в эксперимент 'квадрат')
      {
      отобрази фотографии пользователей в квадратными;
      };
    ```

* выбрать финальный вариант;
* удалить изменения для каждого случая на каждой странице;
* применить выбранные изменения для каждого случая.

Чтобы провести такое тестирование в БЭМ-проекте, достаточно создать отдельный уровень переопределения для каждого эксперимента.

```files
project/                    
    blocks/                 # блоки проекта
        user-pic/           # блок `user-pic`
        headr другие отступы
        user name - другой шрифт
        ...
    эксперименты/
        test-circle/        # уровень для эксперимента 'круг'
            user-pic/       # блок `user-pic` с измененными круглыми фотографиями 
        test-square/        # уровень для эксперимента 'квадрат'
            user-pic/       # блок `user-pic` с измененными квадратными фотографиями  
        test-n/             # уровень для любого нового эксперимента
            user-pic/       # блок `user-pic` с любыми новыми изменениями
```

Во время экспериментов код рабочего проекта не изменяется. 

Чтобы убрать из проекта неподходящий вариант, достаточно удалить директорию — уровень переопределения неудачного эксперимента.

> Также можно проводить эксперименты, меняя поведение блока или разметку страницы. Например, чтобы добавить новые теги для обеспечения доступности сайта (a11y), необходимо переопределить шаблоны и JavaScript-код.
